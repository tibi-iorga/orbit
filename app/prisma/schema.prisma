generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_POSTGRES_URL_NON_POOLING")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  passwordHash   String
  createdAt      DateTime  @default(now())
}

model Product {
  id          String         @id @default(cuid())
  name        String
  description String?
  parentId    String?
  parent      Product?       @relation("ProductHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    Product[]      @relation("ProductHierarchy")
  createdAt   DateTime       @default(now())
  imports     ImportRecord[]
  feedbackItems FeedbackItem[]
  opportunities Opportunity[]

  @@index([name])
  @@index([parentId])
}

model ImportRecord {
  id            String         @id @default(cuid())
  filename      String
  productId     String?
  product       Product?       @relation(fields: [productId], references: [id], onDelete: SetNull)
  createdAt     DateTime       @default(now())
  feedbackItems FeedbackItem[]
}

model Opportunity {
  id            String                    @id @default(cuid())
  title         String
  description   String?
  productId     String?
  product       Product?                  @relation(fields: [productId], references: [id], onDelete: SetNull)
  scores        String?                   // JSON: { dimensionId: value }
  explanation   String?                   // JSON: { dimensionId: "short explanation" }
  reportSummary String?
  horizon       String?                   // "now" | "next" | "later"
  quarter       String?                   // e.g. "Q2 2025"
  status        String                    @default("draft")  // "draft" | "under_review" | "approved" | "on_roadmap" | "rejected"
  createdAt     DateTime                  @default(now())
  feedbackLinks FeedbackItemOpportunity[]

  @@index([productId])
  @@index([horizon])
}

model FeedbackItemOpportunity {
  feedbackItemId  String
  opportunityId   String
  feedbackItem    FeedbackItem @relation(fields: [feedbackItemId], references: [id], onDelete: Cascade)
  opportunity     Opportunity  @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now())

  @@id([feedbackItemId, opportunityId])
  @@index([opportunityId])
}

model Dimension {
  id        String  @id @default(cuid())
  name      String
  type      String  // "yesno" | "scale"
  weight    Float   @default(1)
  order     Int     @default(0)
  tag       String  @default("") // free-text scoring hint
  direction String  @default("benefit") // "benefit" (higher = better) | "cost" (higher = worse)
  archived  Boolean @default(false)
}

// Generic key-value store for app-level settings (prompt, API key override, etc.)
model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model FeedbackItem {
  id               String                    @id @default(cuid())
  title            String
  description      String?
  metadata         Json?                     // stores unmapped CSV columns verbatim
  status           String                    @default("new") // "new" | "reviewed" | "rejected"
  importId         String
  import           ImportRecord              @relation(fields: [importId], references: [id], onDelete: Cascade)
  productId        String?
  product          Product?                  @relation(fields: [productId], references: [id], onDelete: SetNull)
  createdAt        DateTime                  @default(now())
  opportunityLinks FeedbackItemOpportunity[]

  @@index([importId])
  @@index([productId])
  @@index([status])
}
